version: 2
jobs:
  build:
    working_directory: ~/yy
    docker:
      - image: circleci/build-image:ubuntu-14.04-XXL-927-41cd8fe
    steps:
      - setup_docker_engine
      - checkout
      - run:
          command: |
            mkdir -p default/runtime/log && chmod a+rwX -R default/runtime && \
            cd docker && docker-compose up -d && \
            sleep 20 && \
            docker-compose ps && \
            docker-compose logs php && \
            docker-compose exec -T php sh -c "curl -sS https://getcomposer.org/installer | sudo php -- --install-dir=/usr/local/bin --filename=composer" && \
            docker-compose exec -T php composer update && \
            docker-compose exec -T php vendor/bin/phpunit
